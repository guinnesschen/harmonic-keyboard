I don't think the automatic voice leading logic is working correctly. I works sometimes, but oten times the chords jump around. I think it might have to do with how we are keeping track of the previous chord, especialyl when the user presses certain new keys first (since it's hard to press all of the new chord keys at the exact same timeâ€“so there were almost always be some intermediate chord states which aren't completley intended).

The way I want to do this is simple. It's constrained wasserstein optimziation. We pick the next chord to minimize the total voice movement subject to the constraint that all of the required notes are covered. To calculate the total voice movement, you take your two voicings, and pair the voices together, in such a way that each pair has exactly one voice from the prev voicing and one from the new once, and every voice in both prev and new are in some pair. Then calculate the different in MIDI note values for each pair, then sum up all those differences. That represents the total voice movcement, and we want to minimzie it. Note that this means we should always be doing 5 note voicings, even for the triads. Where 5 note is bass + a 4 note voicing. So for the triads, you can pick one of the existing notes to double. Doesn't matter which one. Just pick the one such that the total voice movement is minimized.

Try to come up with an efficient algorithm to do the above process.

And think about how we should deal with the intermediate chord transition states while the user is lifitng off of the previous chord and pressing the new chord. I actually am not sure this matters. Even if the user presses some keys from teh new chord ealier than others, if we do the voice leading corectly, then the new intermedaite chord should still be smoothly voice led from the prev one, and then once the user presses anotehr key eown, it will also be smoothly voice led. So since eberything will be so close togheter, I think this problem will take care of itself. Just as long as we do the voice leading correctly and properly store the last voice. btw we should always store the last voice. If I play a chord, then left off, pause with no sound for a couple seconds, then play a new chord, that new chord shoudl still be voice led from the previous voicing.